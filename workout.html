<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Trainer</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }
        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            padding: 0px;
            margin: 0;
        }
        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card);
            padding: 2rem;
            border-radius: 16px;
            shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        h1 { margin-top: 0; margin-bottom: 0.25rem; font-size: 1.5rem; text-align: center; color: var(--primary); }
        .tagline { text-align: center; font-size: 0.85rem; font-style: italic; color: #64748b; margin-bottom: 1.5rem; }
        .selector-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.8rem; }
        select {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            font-size: 0.85rem;
            background: white;
        }
        .workout-display {
            border-top: 2px solid #f1f5f9;
            margin-top: 1rem;
            padding-top: 1rem;
        }
        .day-title {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .randomize-icon {
            font-size: 1.3rem;
            color: #94a3b8;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }
        .randomize-icon:hover {
            color: #64748b;
        }
        .randomize-icon:active {
            color: var(--primary);
        }
        ul { list-style: none; padding: 0; }
        li {
            padding: 10px;
            background: #f1f5f9;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            flex-wrap: wrap;
        }
        li::before { content: "•"; color: var(--primary); font-weight: bold; margin-right: 10px; }
        .exercise-name {
            flex: 1;
        }
        .exercise-note {
            font-size: 0.8rem;
            font-style: italic;
            color: #64748b;
            margin-left: auto;
            padding-left: 10px;
        }
        .note-input {
            width: 100%;
            margin-top: 8px;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: inherit;
        }
        .note-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .swap-container {
            width: 100%;
            margin-top: 4px;
            display: flex;
            justify-content: flex-end;
        }
        .swap-link {
            font-size: 0.75rem;
            color: #64748b;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
            padding: 2px 4px;
        }
        .swap-link:hover {
            color: var(--primary);
            text-decoration: underline;
        }
        .swap-link:active {
            color: #1e40af;
        }
        .habit-section {
            margin-top: 1.5rem;
            padding: 10px;
            background: #eff6ff;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #1e40af;
        }
        .history-section {
            margin-top: 1.5rem;
            border-top: 2px solid #f1f5f9;
            padding-top: 1rem;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            color: #334155;
            background: #f8fafc;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .history-header:hover {
            background: #f1f5f9;
        }
        .expand-icon {
            transition: transform 0.3s;
            font-size: 0.8rem;
            color: #64748b;
        }
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        .history-content {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 0.5rem;
        }
        .history-item {
            margin-bottom: 0.5rem;
            padding: 8px 10px;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .history-item:hover {
            background: #f1f5f9;
        }
        .history-date {
            font-weight: 500;
            color: #334155;
        }
        .history-date.today {
            color: var(--primary);
        }
        .history-exercises {
            font-size: 0.8rem;
            color: #64748b;
            padding-left: 1rem;
            margin-top: 0.5rem;
            display: none;
        }
        .history-exercises.expanded {
            display: block;
        }
        .history-exercises li {
            padding: 4px 0;
            background: transparent;
            margin-bottom: 2px;
            border-radius: 0;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Today's Workout</h1>
    <p class="tagline">Weight loss • Pullup • 5k</p>

    <div class="selector-group">
        <label for="daySelect">Select Training Day:</label>
        <select id="daySelect" onchange="generateWorkout()">
            <option value="Friday">Friday - Upper + Easy Run</option>
            <option value="Saturday">Saturday - Legs</option>
            <option value="Sunday">Sunday - Push + Speed Run</option>
            <option value="Monday">Monday - Pull</option>
            <option value="Tuesday">Tuesday - Easy Cardio</option>
            <option value="Wednesday">Wednesday - Rest</option>
            <option value="Thursday">Thursday - Long Run</option>
        </select>
    </div>

    <div class="workout-display" id="workoutContent">
        </div>

    <div class="history-section">
        <div class="history-header" onclick="toggleHistory()">
            <span>Workout History</span>
            <span class="expand-icon">▼</span>
        </div>
        <div class="history-content" id="historyContent" style="display: none;">
            <!-- Populated dynamically -->
        </div>
    </div>
</div>

<script>
    const trainingData = {
        "Sunday": [
            ["Low Incline Dumbbell Press", "Incline Machine Chest Press"],
            ["Arnold Press", "Single-Arm Overhead Press"],
            ["Cable Flys", "Dumbbell Flys", "Pec Deck"],
            ["Cable Pushdowns", "Overhead Dumbbell Extension"],
            ["Face Pulls", "Cable External Rotations"],
            ["Speed Run: 5x3 min hard / 2 min easy jog"]
        ],
        "Monday": [
            ["Inverted Row"],
            ["Lat Pulldowns"],
            ["Seated Dumbbell Curls", "Hammer Curl", "Dumbbell Reverse Curls"],
            ["Dumbbell Reverse Flys"],
            ["Dead Hangs"]
        ],
        "Tuesday": [["Peloton bike or outdoor jog 30-45 min easy"]],
        "Wednesday": [["Rest Day - Full recovery"]],
        "Thursday": [["Peloton bike or 40-60 min slow steady run or jog/walk"]],
        "Friday": [
            ["Bench Press"],
            ["Barbell Row", "One-Arm Dumbbell Row"],
            ["Lat Pulldowns"],
            ["Cable Flys", "Dumbbell Flys", "Pec Deck"],
            ["Standing ITWY Raises", "Incline ITWY Raises"],
            ["Easy Run: 25-35 min conversational pace"]
        ],
        "Saturday": [
            ["Barbell Squat", "Goblet Squat"],
            ["Barbell Romanian Deadlift"],
            ["Dumbbell Split Squat"],
            ["Leg Press Calf Raises"],
            ["Farmer's Walk"]
        ]
    };

    // Helper functions to convert between storage format (exercise names) and runtime format (indices)
    function indicesToExerciseNames(dayType, currentSelections) {
        const exercises = trainingData[dayType];
        const result = [];
        exercises.forEach((exerciseOptions, index) => {
            const selectedIndex = currentSelections[`${dayType}-${index}`];
            if (selectedIndex !== undefined) {
                result.push(exerciseOptions[selectedIndex]);
            }
        });
        return result;
    }

    function exerciseNamesToIndices(dayType, exerciseNamesArray) {
        const exercises = trainingData[dayType];
        const result = {};

        exerciseNamesArray.forEach((exerciseName, position) => {
            const exerciseOptions = exercises[position];
            if (!exerciseOptions) {
                // Position doesn't exist in current trainingData (e.g., removed exercise)
                return;
            }

            // Find the index of this exercise name in the alternates
            const alternateIndex = exerciseOptions.indexOf(exerciseName);
            if (alternateIndex !== -1) {
                result[`${dayType}-${position}`] = alternateIndex;
            }
            // If not found, leave undefined (caller will randomize)
        });

        return result;
    }

    // Storage abstraction - all storage operations go through these functions
    const WorkoutStorage = {
        // Load all notes from storage
        loadNotes: function() {
            try {
                const saved = localStorage.getItem('workoutNotes');
                return saved ? JSON.parse(saved) : {};
            } catch (error) {
                console.error('Error loading notes:', error);
                return {};
            }
        },

        // Save all notes to storage
        saveNotes: function(notes) {
            try {
                localStorage.setItem('workoutNotes', JSON.stringify(notes));
            } catch (error) {
                console.error('Error saving notes:', error);
            }
        },

        // Get a single exercise note
        getNote: function(exerciseName) {
            const notes = this.loadNotes();
            return notes[exerciseName] || '';
        },

        // Save a single exercise note
        saveNote: function(exerciseName, noteText) {
            const notes = this.loadNotes();
            notes[exerciseName] = noteText;
            this.saveNotes(notes);
        },

        // Load all workout history from storage
        loadHistory: function() {
            try {
                const saved = localStorage.getItem('workoutHistory');
                return saved ? JSON.parse(saved) : {};
            } catch (error) {
                console.error('Error loading history:', error);
                return {};
            }
        },

        // Save all workout history to storage
        saveHistory: function(history) {
            try {
                localStorage.setItem('workoutHistory', JSON.stringify(history));
            } catch (error) {
                console.error('Error saving history:', error);
            }
        },

        // Save a workout session for a specific date
        saveWorkoutSession: function(date, dayType, selectedExercises) {
            const history = this.loadHistory();
            history[date] = {
                date: date,
                dayType: dayType,
                selectedExercises: selectedExercises,
                timestamp: Date.now()
            };
            this.saveHistory(history);
        },

        // Get workout session for a specific date
        getWorkoutSession: function(date) {
            const history = this.loadHistory();
            return history[date] || null;
        },

        // Find most recent workout of a specific day type
        getMostRecentWorkoutByType: function(dayType) {
            const history = this.loadHistory();
            const sessions = Object.values(history)
                .filter(session => session.dayType === dayType)
                .sort((a, b) => b.timestamp - a.timestamp);
            return sessions.length > 0 ? sessions[0] : null;
        }
    };

    // Global state
    let exerciseNotes = {};  // Loaded from localStorage
    let expandedExercise = null;  // Track which exercise input is open
    let currentSelections = {};  // Track current alternate selections: { "day-index": alternateIndex }
    let currentDay = '';  // Current date in YYYY-MM-DD format
    let currentDayType = '';  // Current workout type (e.g., "Friday")

    // Helper function to get today's date in YYYY-MM-DD format
    function getTodayDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function generateWorkout() {
        const day = document.getElementById('daySelect').value;
        const exercises = trainingData[day];
        const display = document.getElementById('workoutContent');

        // Close any open input boxes
        expandedExercise = null;

        // Check if user manually switched day types
        if (day !== currentDayType) {
            // User switched to a different day type
            currentDayType = day;

            // Search for most recent workout of this type
            const recentWorkout = WorkoutStorage.getMostRecentWorkoutByType(day);

            if (recentWorkout) {
                // Load exercise selections from that workout (exact repeat)
                const indices = exerciseNamesToIndices(day, recentWorkout.selectedExercises);

                // Fill in any missing indices with randomization
                exercises.forEach((exerciseOptions, index) => {
                    const selectionKey = `${day}-${index}`;
                    if (indices[selectionKey] === undefined) {
                        indices[selectionKey] = Math.floor(Math.random() * exerciseOptions.length);
                    }
                });

                currentSelections = { ...currentSelections, ...indices };
            } else {
                // No previous workout of this type, randomize
                exercises.forEach((exerciseOptions, index) => {
                    const selectionKey = `${day}-${index}`;
                    currentSelections[selectionKey] = Math.floor(Math.random() * exerciseOptions.length);
                });
            }

            // Save updated session for today
            const selectedExercises = indicesToExerciseNames(day, currentSelections);
            WorkoutStorage.saveWorkoutSession(currentDay, day, selectedExercises);
        }

        let html = `<div class="day-title">
            <span>${day} Routine</span>
            <span class="randomize-icon" onclick="randomizeWorkout()" title="Randomize alternate exercises">⟳</span>
        </div><ul>`;

        exercises.forEach((exerciseOptions, index) => {
            const selectionKey = `${day}-${index}`;

            // Check if we have a tracked selection, otherwise randomize
            let selectedIndex;
            if (currentSelections[selectionKey] !== undefined) {
                selectedIndex = currentSelections[selectionKey];
            } else {
                selectedIndex = Math.floor(Math.random() * exerciseOptions.length);
                currentSelections[selectionKey] = selectedIndex;
            }

            const choice = exerciseOptions[selectedIndex];
            const note = exerciseNotes[choice] || '';
            const exerciseId = `exercise-${index}`;

            // Use data attributes to avoid escaping issues with exercise names
            html += `<li id="${exerciseId}"
                data-exercise="${choice.replace(/"/g, '&quot;')}"
                data-day="${day}"
                data-index="${index}"
                data-alternates-count="${exerciseOptions.length}">
                <span class="exercise-name">${choice}</span>
                <span class="exercise-note">${note}</span>
            </li>`;
        });

        html += `</ul>`;
        display.innerHTML = html;

        // Attach click handlers after rendering
        exercises.forEach((_, index) => {
            const exerciseId = `exercise-${index}`;
            const li = document.getElementById(exerciseId);
            if (li) {
                li.addEventListener('click', function() {
                    toggleNoteInput(exerciseId, this.getAttribute('data-exercise'));
                });
            }
        });
    }

    function randomizeWorkout() {
        const day = document.getElementById('daySelect').value;
        const exercises = trainingData[day];

        // Generate new random selections for all exercises
        exercises.forEach((exerciseOptions, index) => {
            const selectionKey = `${day}-${index}`;
            currentSelections[selectionKey] = Math.floor(Math.random() * exerciseOptions.length);
        });

        // Save updated session
        const selectedExercises = indicesToExerciseNames(currentDayType, currentSelections);
        WorkoutStorage.saveWorkoutSession(currentDay, currentDayType, selectedExercises);

        // Regenerate UI
        generateWorkout();
    }

    function toggleNoteInput(exerciseId, exerciseName) {
        const li = document.getElementById(exerciseId);
        if (!li) return;

        // If this exercise already has an input, remove it
        const existingInput = li.querySelector('.note-input');
        if (existingInput) {
            existingInput.remove();
            // Also remove swap link container if it exists
            const existingSwapContainer = li.querySelector('.swap-container');
            if (existingSwapContainer) existingSwapContainer.remove();
            expandedExercise = null;
            return;
        }

        // Close any other open input first (one at a time)
        if (expandedExercise) {
            const prevInput = document.querySelector('.note-input');
            if (prevInput) prevInput.remove();
            const prevSwapContainer = document.querySelector('.swap-container');
            if (prevSwapContainer) prevSwapContainer.remove();
        }

        // Create and insert input box
        const currentNote = exerciseNotes[exerciseName] || '';
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'note-input';
        input.value = currentNote;
        input.placeholder = 'e.g., 70x12 75x10 80x8';

        // Auto-save on input
        input.addEventListener('input', (e) => {
            const newNote = e.target.value;
            exerciseNotes[exerciseName] = newNote;
            WorkoutStorage.saveNote(exerciseName, newNote);
            // Update the note display
            li.querySelector('.exercise-note').textContent = newNote;
        });

        // Auto-close on blur
        input.addEventListener('blur', () => {
            setTimeout(() => {
                if (input.parentNode) {
                    input.remove();
                    const swapContainer = li.querySelector('.swap-container');
                    if (swapContainer) swapContainer.remove();
                }
            }, 150);  // Delay to allow click events
            expandedExercise = null;
        });

        // Prevent click on input from closing it
        input.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        li.appendChild(input);
        input.focus();
        expandedExercise = exerciseId;

        // Add swap link if there are alternates
        const alternatesCount = parseInt(li.getAttribute('data-alternates-count'));
        if (alternatesCount > 1) {
            const swapContainer = document.createElement('div');
            swapContainer.className = 'swap-container';

            const swapLink = document.createElement('a');
            swapLink.href = '#';
            swapLink.className = 'swap-link';
            swapLink.textContent = 'swap';

            swapLink.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                swapExercise(exerciseId, input);
            });

            // Prevent blur when clicking swap link (important!)
            swapLink.addEventListener('mousedown', (e) => {
                e.preventDefault();  // Prevents input from losing focus
            });

            swapContainer.appendChild(swapLink);
            li.appendChild(swapContainer);
        }
    }

    function swapExercise(exerciseId, inputElement) {
        const li = document.getElementById(exerciseId);
        if (!li) return;

        // Get metadata from data attributes
        const day = li.getAttribute('data-day');
        const index = parseInt(li.getAttribute('data-index'));
        const alternatesCount = parseInt(li.getAttribute('data-alternates-count'));

        // Calculate next index (with wrapping)
        const selectionKey = `${day}-${index}`;
        const currentIndex = currentSelections[selectionKey];
        const nextIndex = (currentIndex + 1) % alternatesCount;

        // Update selection tracking
        currentSelections[selectionKey] = nextIndex;

        // Get new exercise name
        const exerciseOptions = trainingData[day][index];
        const newExerciseName = exerciseOptions[nextIndex];

        // Update UI
        li.querySelector('.exercise-name').textContent = newExerciseName;
        li.setAttribute('data-exercise', newExerciseName);

        // Load note for new exercise
        const newNote = exerciseNotes[newExerciseName] || '';
        li.querySelector('.exercise-note').textContent = newNote;

        // Recreate input with new exercise context
        if (inputElement.parentNode) {
            inputElement.remove();
        }
        const swapContainer = li.querySelector('.swap-container');
        if (swapContainer) {
            swapContainer.remove();
        }

        expandedExercise = null;
        toggleNoteInput(exerciseId, newExerciseName);

        // Save updated session after swapping
        const selectedExercises = indicesToExerciseNames(currentDayType, currentSelections);
        WorkoutStorage.saveWorkoutSession(currentDay, currentDayType, selectedExercises);
    }

    // Toggle history section visibility
    function toggleHistory() {
        const content = document.getElementById('historyContent');
        const icon = document.querySelector('.expand-icon');

        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.classList.add('expanded');
            renderHistory();
        } else {
            content.style.display = 'none';
            icon.classList.remove('expanded');
        }
    }

    // Render workout history
    function renderHistory() {
        const content = document.getElementById('historyContent');
        const history = WorkoutStorage.loadHistory();
        const sessions = Object.values(history).sort((a, b) => b.timestamp - a.timestamp);

        if (sessions.length === 0) {
            content.innerHTML = '<p style="padding: 10px; text-align: center; color: #94a3b8; font-size: 0.85rem;">No workout history yet</p>';
            return;
        }

        // Show last 60 days
        const maxSessions = sessions.slice(0, 60);

        let html = '';
        maxSessions.forEach((session, index) => {
            const date = new Date(session.date);
            const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][date.getDay()];
            const monthName = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][date.getMonth()];
            const dayOfMonth = date.getDate();
            const isToday = session.date === currentDay;
            const itemId = `history-item-${index}`;

            html += `<div class="history-item" id="${itemId}" onclick="toggleHistoryItem('${itemId}')">
                <div class="history-date ${isToday ? 'today' : ''}">
                    ${dayName}, ${monthName} ${dayOfMonth}: ${session.dayType}
                </div>
                <ul class="history-exercises" id="${itemId}-exercises">`;

            session.selectedExercises.forEach(exercise => {
                const note = exerciseNotes[exercise] || '';
                const noteDisplay = note ? ` <span style="color: #94a3b8;">• ${note}</span>` : '';
                html += `<li>• ${exercise}${noteDisplay}</li>`;
            });

            html += `</ul></div>`;
        });

        content.innerHTML = html;
    }

    // Toggle individual history item expansion
    function toggleHistoryItem(itemId) {
        const exercises = document.getElementById(`${itemId}-exercises`);
        if (exercises) {
            exercises.classList.toggle('expanded');
        }
    }

    // Initialize the application
    function initializeApp() {
        // Load notes from storage
        exerciseNotes = WorkoutStorage.loadNotes();

        // Set current day to today's date
        currentDay = getTodayDate();

        // Try to load today's workout session
        const todaySession = WorkoutStorage.getWorkoutSession(currentDay);

        if (todaySession) {
            // Load existing session
            currentDayType = todaySession.dayType;

            // Convert exercise names to indices for current trainingData
            const indices = exerciseNamesToIndices(currentDayType, todaySession.selectedExercises);

            // Fill in any missing indices with randomization (handles removed exercises)
            const exercises = trainingData[currentDayType];
            exercises.forEach((exerciseOptions, index) => {
                const selectionKey = `${currentDayType}-${index}`;
                if (indices[selectionKey] === undefined) {
                    indices[selectionKey] = Math.floor(Math.random() * exerciseOptions.length);
                }
            });

            currentSelections = indices;
        } else {
            // Create new session
            // Set dayType based on day of week
            currentDayType = Object.keys(trainingData)[new Date().getDay()];

            // Randomize alternate exercises
            const exercises = trainingData[currentDayType];
            exercises.forEach((exerciseOptions, index) => {
                const selectionKey = `${currentDayType}-${index}`;
                currentSelections[selectionKey] = Math.floor(Math.random() * exerciseOptions.length);
            });

            // Save the new session
            const selectedExercises = indicesToExerciseNames(currentDayType, currentSelections);
            WorkoutStorage.saveWorkoutSession(currentDay, currentDayType, selectedExercises);
        }

        // Update UI
        document.getElementById('daySelect').value = currentDayType;
        generateWorkout();
    }

    // Run on load
    initializeApp();
</script>

</body>
</html>
